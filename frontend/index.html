<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Pipeline â€” Microsoft Agent Framework</title>
  <style>
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --surface-hover: #1c2129;
      --border: #30363d;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --accent: #58a6ff;
      --accent-hover: #79b8ff;
      --researcher: #f0883e;
      --writer: #a371f7;
      --reviewer: #3fb950;
      --danger: #f85149;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ---- Header ---- */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-shrink: 0;
    }

    header h1 {
      font-size: 16px;
      font-weight: 600;
      white-space: nowrap;
    }

    header h1 span { color: var(--accent); }

    .mode-toggle {
      display: flex;
      background: var(--bg);
      border-radius: 8px;
      padding: 3px;
      gap: 2px;
      margin-left: auto;
    }

    .mode-btn {
      padding: 6px 14px;
      border: none;
      border-radius: 6px;
      background: transparent;
      color: var(--text-muted);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .mode-btn.active {
      background: var(--accent);
      color: #fff;
    }

    .mode-btn:hover:not(.active) { color: var(--text); }

    /* ---- Main ---- */
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      max-width: 900px;
      width: 100%;
      margin: 0 auto;
    }

    /* ---- Messages area ---- */
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .msg {
      max-width: 100%;
      line-height: 1.6;
      font-size: 14px;
    }

    .msg-user {
      align-self: flex-end;
      background: #1f3a5f;
      padding: 10px 16px;
      border-radius: 12px 12px 4px 12px;
      max-width: 70%;
    }

    .msg-agent {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 18px;
      overflow: hidden;
    }

    .agent-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .agent-label .dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      display: inline-block;
    }

    .agent-label.researcher { color: var(--researcher); }
    .agent-label.researcher .dot { background: var(--researcher); }
    .agent-label.writer { color: var(--writer); }
    .agent-label.writer .dot { background: var(--writer); }
    .agent-label.reviewer { color: var(--reviewer); }
    .agent-label.reviewer .dot { background: var(--reviewer); }

    .agent-text {
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .agent-divider {
      border: none;
      border-top: 1px dashed var(--border);
      margin: 12px 0;
    }

    .status-msg {
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
      padding: 8px;
    }

    .status-msg.error { color: var(--danger); }

    /* ---- Input area ---- */
    .input-area {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0;
    }

    .agent-selector {
      display: none;
      margin-bottom: 10px;
      gap: 6px;
    }

    .agent-selector.visible { display: flex; }

    .agent-chip {
      padding: 5px 12px;
      border: 1px solid var(--border);
      border-radius: 20px;
      background: transparent;
      color: var(--text-muted);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .agent-chip.active { border-color: var(--accent); color: var(--accent); }
    .agent-chip:hover:not(.active) { border-color: var(--text-muted); color: var(--text); }

    .input-row {
      display: flex;
      gap: 10px;
    }

    #input {
      flex: 1;
      padding: 10px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      outline: none;
      resize: none;
      min-height: 42px;
      max-height: 120px;
    }

    #input:focus { border-color: var(--accent); }

    #input::placeholder { color: var(--text-muted); }

    #send-btn {
      padding: 10px 20px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
      white-space: nowrap;
    }

    #send-btn:hover { background: var(--accent-hover); }
    #send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* ---- Scrollbar ---- */
    #messages::-webkit-scrollbar { width: 6px; }
    #messages::-webkit-scrollbar-track { background: transparent; }
    #messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* ---- Welcome ---- */
    .welcome {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      gap: 12px;
      color: var(--text-muted);
      text-align: center;
      padding: 40px;
    }

    .welcome h2 {
      font-size: 20px;
      color: var(--text);
    }

    .welcome p { font-size: 14px; max-width: 480px; }

    .welcome .agents-row {
      display: flex;
      gap: 24px;
      margin-top: 12px;
    }

    .welcome .agent-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-size: 13px;
    }

    .welcome .agent-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .welcome .agent-icon.r { background: rgba(240,136,62,0.15); }
    .welcome .agent-icon.w { background: rgba(163,113,247,0.15); }
    .welcome .agent-icon.v { background: rgba(63,185,80,0.15); }
  </style>
</head>
<body>
  <header>
    <h1><span>Agent</span> Content Pipeline</h1>
    <div class="mode-toggle">
      <button class="mode-btn active" data-mode="pipeline">Pipeline</button>
      <button class="mode-btn" data-mode="agent">Single Agent</button>
    </div>
  </header>

  <main>
    <div id="messages">
      <div class="welcome" id="welcome">
        <h2>Multi-Agent Content Pipeline</h2>
        <p>Enter a topic to run the full Researcher &rarr; Writer &rarr; Reviewer pipeline, or switch to Single Agent mode to chat with an agent directly.</p>
        <div class="agents-row">
          <div class="agent-card">
            <div class="agent-icon r">&#128270;</div>
            <span style="color:var(--researcher)">Researcher</span>
          </div>
          <div class="agent-card">
            <div class="agent-icon w">&#9997;</div>
            <span style="color:var(--writer)">Writer</span>
          </div>
          <div class="agent-card">
            <div class="agent-icon v">&#9989;</div>
            <span style="color:var(--reviewer)">Reviewer</span>
          </div>
        </div>
      </div>
    </div>

    <div class="input-area">
      <div class="agent-selector" id="agent-selector">
        <button class="agent-chip active" data-agent="researcher">Researcher</button>
        <button class="agent-chip" data-agent="writer">Writer</button>
        <button class="agent-chip" data-agent="reviewer">Reviewer</button>
      </div>
      <div class="input-row">
        <textarea id="input" rows="1" placeholder="Enter a topic for the pipeline..."></textarea>
        <button id="send-btn">Run</button>
      </div>
    </div>
  </main>

  <script>
    const API_BASE = window.location.origin;
    const messagesEl = document.getElementById("messages");
    const welcomeEl = document.getElementById("welcome");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("send-btn");
    const agentSelector = document.getElementById("agent-selector");

    let mode = "pipeline";
    let selectedAgent = "researcher";
    let isStreaming = false;

    // ---- Mode toggle ----
    document.querySelectorAll(".mode-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        if (isStreaming) return;
        document.querySelector(".mode-btn.active").classList.remove("active");
        btn.classList.add("active");
        mode = btn.dataset.mode;

        if (mode === "agent") {
          agentSelector.classList.add("visible");
          inputEl.placeholder = `Message the ${capitalize(selectedAgent)} agent...`;
          sendBtn.textContent = "Send";
        } else {
          agentSelector.classList.remove("visible");
          inputEl.placeholder = "Enter a topic for the pipeline...";
          sendBtn.textContent = "Run";
        }
      });
    });

    // ---- Agent selector ----
    document.querySelectorAll(".agent-chip").forEach((chip) => {
      chip.addEventListener("click", () => {
        document.querySelector(".agent-chip.active").classList.remove("active");
        chip.classList.add("active");
        selectedAgent = chip.dataset.agent;
        inputEl.placeholder = `Message the ${capitalize(selectedAgent)} agent...`;
      });
    });

    // ---- Auto-resize textarea ----
    inputEl.addEventListener("input", () => {
      inputEl.style.height = "auto";
      inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + "px";
    });

    // ---- Send on Enter (Shift+Enter for newline) ----
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    sendBtn.addEventListener("click", handleSend);

    // ---- Main send handler ----
    async function handleSend() {
      const text = inputEl.value.trim();
      if (!text || isStreaming) return;

      // Hide welcome
      if (welcomeEl) welcomeEl.remove();

      // Show user message
      addUserMessage(text);

      // Clear input
      inputEl.value = "";
      inputEl.style.height = "auto";

      // Disable
      isStreaming = true;
      sendBtn.disabled = true;

      if (mode === "pipeline") {
        await streamPipeline(text);
      } else {
        await streamAgent(selectedAgent, text);
      }

      isStreaming = false;
      sendBtn.disabled = false;
    }

    // ---- Stream pipeline ----
    async function streamPipeline(topic) {
      const container = createAgentMessageContainer();
      let currentAgentEl = null;

      try {
        const response = await fetch(`${API_BASE}/api/pipeline`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ topic }),
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        await processSSEStream(response.body, {
          onAgent(name) {
            // Add divider if not the first agent
            if (currentAgentEl) {
              container.appendChild(createEl("hr", "agent-divider"));
            }
            const label = createEl("div", `agent-label ${name.toLowerCase()}`);
            label.innerHTML = `<span class="dot"></span>${name}`;
            container.appendChild(label);

            const textEl = createEl("div", "agent-text");
            container.appendChild(textEl);
            currentAgentEl = textEl;
            scrollToBottom();
          },
          onText(text) {
            if (currentAgentEl) {
              currentAgentEl.textContent += text;
              scrollToBottom();
            }
          },
          onDone() {
            addStatus("Pipeline complete");
          },
        });
      } catch (err) {
        addStatus(`Error: ${err.message}`, true);
      }
    }

    // ---- Stream individual agent ----
    async function streamAgent(agentName, message) {
      const container = createAgentMessageContainer();

      const label = createEl("div", `agent-label ${agentName}`);
      label.innerHTML = `<span class="dot"></span>${capitalize(agentName)}`;
      container.appendChild(label);

      const textEl = createEl("div", "agent-text");
      container.appendChild(textEl);

      try {
        const response = await fetch(`${API_BASE}/api/agents/${agentName}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message }),
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        await processSSEStream(response.body, {
          onAgent() {},
          onText(text) {
            textEl.textContent += text;
            scrollToBottom();
          },
          onDone() {},
        });
      } catch (err) {
        addStatus(`Error: ${err.message}`, true);
      }
    }

    // ---- SSE stream processor (using fetch + ReadableStream) ----
    async function processSSEStream(body, handlers) {
      const reader = body.getReader();
      const decoder = new TextDecoder();
      let buffer = "";

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split("\n");
        buffer = lines.pop(); // Keep incomplete line in buffer

        let currentEvent = null;

        for (const line of lines) {
          if (line.startsWith("event:")) {
            currentEvent = line.slice(6).trim();
          } else if (line.startsWith("data:")) {
            const raw = line.slice(5).trim();
            if (!raw) continue;

            try {
              const data = JSON.parse(raw);

              if (currentEvent === "agent" && data.agent) {
                handlers.onAgent(data.agent);
              } else if (currentEvent === "text" && data.text) {
                handlers.onText(data.text);
              } else if (currentEvent === "done") {
                handlers.onDone();
              }
            } catch {
              // Ignore non-JSON data lines
            }
            currentEvent = null;
          } else if (line.trim() === "") {
            currentEvent = null;
          }
        }
      }
    }

    // ---- DOM helpers ----
    function createEl(tag, className) {
      const el = document.createElement(tag);
      if (className) el.className = className;
      return el;
    }

    function addUserMessage(text) {
      const el = createEl("div", "msg msg-user");
      el.textContent = text;
      messagesEl.appendChild(el);
      scrollToBottom();
    }

    function createAgentMessageContainer() {
      const el = createEl("div", "msg msg-agent");
      messagesEl.appendChild(el);
      scrollToBottom();
      return el;
    }

    function addStatus(text, isError = false) {
      const el = createEl("div", `status-msg${isError ? " error" : ""}`);
      el.textContent = text;
      messagesEl.appendChild(el);
      scrollToBottom();
    }

    function scrollToBottom() {
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function capitalize(s) {
      return s.charAt(0).toUpperCase() + s.slice(1);
    }
  </script>
</body>
</html>
